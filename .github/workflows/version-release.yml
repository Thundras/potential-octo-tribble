name: Bump version and create release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  bump-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine bump and update version
        id: bump
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          pr_number=""
          if [[ "${{ github.event.head_commit.message }}" =~ \(\#([0-9]+)\) ]]; then
            pr_number="${BASH_REMATCH[1]}"
          fi

          bump="patch"
          if [[ -n "$pr_number" ]]; then
            labels=$(gh api "repos/${{ github.repository }}/pulls/${pr_number}" --jq '.labels[].name' || true)
            if echo "$labels" | grep -q "release:major"; then
              bump="major"
            elif echo "$labels" | grep -q "release:minor"; then
              bump="minor"
            elif echo "$labels" | grep -q "release:patch"; then
              bump="patch"
            fi
          fi

          assembly_file="7D2D_ServerInfo/Properties/AssemblyInfo.cs"
          current_version=$(python scripts/version_release.py current)

          new_version=$(python scripts/version_release.py bump "$bump")

          if [[ "$current_version" == "${new_version}.0" ]]; then
            echo "Version unchanged; skipping release."
            echo "released=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$assembly_file" docs/release-notes.md
          git commit -m "chore: bump version to ${new_version}"
          git tag "v${new_version}"
          git push origin HEAD:main --tags
          echo "released=true" >> "$GITHUB_OUTPUT"
          echo "version=${new_version}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        if: steps.bump.outputs.released == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          version="${{ steps.bump.outputs.version }}"
          gh release create "v${version}" --title "v${version}" --notes "Automated release for v${version}."
